<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Renkli Hafƒ±za Satrancƒ±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        :root {
            --wood-dark: #8b4513;
            --wood-light: #deb887;
            --wood-board: #eecfa1;
            --accent: #ff9800;
            --bg-color: #2c3e50;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 50% 50%, #34495e 0%, #2c3e50 100%);
            font-family: 'Fredoka', sans-serif;
            color: #333;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        /* --- UI KATMANLARI --- */
        #game-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Men√º Ekranƒ± */
        #menu-screen, #round-over-screen {
            position: absolute;
            z-index: 50;
            background: rgba(0, 0, 0, 0.85);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
            transition: opacity 0.5s;
        }

        .menu-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 90%;
            border: 4px solid var(--wood-light);
        }

        h1 {
            color: var(--wood-dark);
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        h2 {
            color: #d35400;
            font-size: 1.8rem;
            margin: 10px 0;
        }

        p.subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .score-summary {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
            padding: 10px;
            background: #f1f2f6;
            border-radius: 10px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 5px 0 #e65100;
        }

        .btn-primary:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #e65100;
        }

        .btn-secondary {
            background: #3498db;
            color: white;
            box-shadow: 0 5px 0 #2980b9;
        }

        .btn-secondary:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #2980b9;
        }

        /* Oyun Aray√ºz√º */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            z-index: 10;
        }

        .player-panel {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .player-card {
            background: white;
            padding: 10px 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 110px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
            position: relative;
        }

        .player-card.active {
            transform: scale(1.05);
            border-color: #27ae60;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.6);
            z-index: 5;
        }

        .player-name { font-size: 0.85rem; color: #7f8c8d; font-weight: 600; margin-bottom: 5px; }
        
        .score-container {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .player-score { font-size: 1.8rem; color: #2c3e50; font-weight: bold; }
        
        .match-wins {
            display: flex;
            gap: 3px;
        }
        
        .win-star {
            width: 15px;
            height: 15px;
            background: #ecf0f1;
            border-radius: 50%;
            border: 1px solid #bdc3c7;
        }
        
        .win-star.filled {
            background: #f1c40f;
            border-color: #f39c12;
            box-shadow: 0 0 5px #f1c40f;
        }
        
        .score-label { font-size: 0.7rem; color: #95a5a6; }

        #turn-indicator {
            position: absolute;
            top: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            color: #d35400;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        /* Oyun Tahtasƒ± (Canvas) */
        canvas {
            border-radius: 50%;
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.5),
                inset 0 0 60px rgba(139, 69, 19, 0.4);
            cursor: pointer;
            background: #deb887; 
            background-image: 
                radial-gradient(transparent 90%, rgba(0,0,0,0.1) 100%);
        }

        /* Kontrol Alanƒ± (Zar vb) */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
            z-index: 20;
        }

        #message-bubble {
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 220px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
        }
        
        #message-bubble.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #dice-box {
            width: 90px;
            height: 90px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 
                0 10px 0 #bdc3c7,
                0 25px 30px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
            border: 2px solid #ecf0f1;
            transition: border-color 0.3s;
        }

        #dice-box:active {
            transform: translateY(4px);
            box-shadow: 
                0 6px 0 #bdc3c7,
                0 15px 15px rgba(0,0,0,0.2);
        }

        #dice-box.disabled {
            filter: grayscale(0.5); 
            cursor: not-allowed;
            pointer-events: none;
            opacity: 0.9;
        }

        .dice-face {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #ecf0f1;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s;
            border: 4px solid rgba(255,255,255,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dice-label {
            margin-top: 15px;
            color: white;
            font-size: 1.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 10px;
            min-width: 80px;
            text-align: center;
        }
        
        /* Ekstra Kontroller (Karƒ±≈ütƒ±rma Butonu) */
        #extra-controls {
            position: absolute;
            /* Mobilde zarƒ±n √ºst√ºnde kalmasƒ± i√ßin a≈üaƒüƒ±dan daha fazla bo≈üluk */
            bottom: 140px; 
            right: 20px;
            z-index: 20;
            pointer-events: auto;
            display: none; /* JS ile a√ßƒ±lƒ±r */
        }

        /* K√º√ß√ºk ekranlar i√ßin d√ºzenleme */
        @media (max-width: 480px) {
            #extra-controls {
                bottom: 150px; /* Zardan yeterince yukarƒ±da */
                right: 15px;
            }
            .btn-round {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }

        .btn-round {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background: #e67e22;
            color: white;
            font-size: 2rem;
            box-shadow: 0 5px 0 #d35400, 0 10px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .btn-round:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 #d35400, 0 5px 10px rgba(0,0,0,0.3);
        }
        
        .btn-round:disabled {
            background: #bdc3c7;
            box-shadow: 0 5px 0 #95a5a6;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .tooltip {
            position: absolute;
            top: 50%;
            right: 85px; /* Butonun solunda g√∂r√ºns√ºn mobilde */
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .btn-round:hover .tooltip {
            opacity: 1;
        }

        /* Round Over Ekranƒ± */
        #round-over-screen {
            display: none; 
        }

    </style>
</head>
<body>

<div id="game-wrapper">

    <!-- Ana Men√º -->
    <div id="menu-screen">
        <div class="menu-card">
            <h1>HAFIZA SATRANCI</h1>
            <p class="subtitle">Set Usul√º: 3 Tur Alan Kazanƒ±r!<br>Bir turda 15 ta≈ü toplayan turu alƒ±r.</p>
            
            <button class="btn btn-secondary" onclick="startGame('pvc')">ü§ñ Bilgisayara Kar≈üƒ±</button>
            <button class="btn btn-primary" onclick="startGame('pvp')">üë• ƒ∞ki Ki≈üilik (Yan Yana)</button>
        </div>
    </div>

    <!-- Tur / Oyun Sonu Ekranƒ± -->
    <div id="round-over-screen">
        <div class="menu-card">
            <h2 id="round-title">TUR Bƒ∞TTƒ∞</h2>
            <div id="round-winner-text" class="score-summary" style="color:#e67e22;">Kazanan: OYUNCU 1</div>
            
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
                 <div style="text-align:center;">
                     <div style="font-size:0.8rem; color:#7f8c8d;">P1 SET</div>
                     <div id="final-sets-1" style="font-size:2rem; font-weight:bold;">1</div>
                 </div>
                 <div style="font-size:2rem; font-weight:bold; color:#bdc3c7;">-</div>
                 <div style="text-align:center;">
                     <div style="font-size:0.8rem; color:#7f8c8d;">P2 SET</div>
                     <div id="final-sets-2" style="font-size:2rem; font-weight:bold;">0</div>
                 </div>
            </div>

            <p id="round-score-detail" style="font-size:0.9rem; color:#95a5a6;">Ta≈ülar: 15 - 4</p>

            <button id="next-round-btn" class="btn btn-primary" onclick="nextRound()">Sƒ±radaki Tur ‚û°Ô∏è</button>
            <button id="main-menu-btn" class="btn btn-secondary" onclick="showMenu()">Ana Men√º üè†</button>
        </div>
    </div>

    <!-- Oyun UI -->
    <div id="ui-layer" style="display:none;">
        <div class="player-panel">
            <!-- P1 Kartƒ± -->
            <div id="p1-card" class="player-card active">
                <span class="player-name" id="p1-name">OYUNCU 1</span>
                <div class="score-container">
                    <span class="player-score" id="p1-score">0</span>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span class="score-label">SET</span>
                        <div class="match-wins" id="p1-wins">
                            <div class="win-star"></div>
                            <div class="win-star"></div>
                            <div class="win-star"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- P2 Kartƒ± -->
            <div id="p2-card" class="player-card">
                <span class="player-name" id="p2-name">Bƒ∞LGƒ∞SAYAR</span>
                <div class="score-container">
                    <span class="player-score" id="p2-score">0</span>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span class="score-label">SET</span>
                        <div class="match-wins" id="p2-wins">
                            <div class="win-star"></div>
                            <div class="win-star"></div>
                            <div class="win-star"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="turn-indicator">Sƒ±ra Sende!</div>
    </div>
    
    <!-- Karƒ±≈ütƒ±rma Butonu -->
    <div id="extra-controls">
        <button id="shuffle-btn" class="btn-round" title="Ta≈ülarƒ± Karƒ±≈ütƒ±r">
            üîÑ
            <span class="tooltip">Ta≈ülarƒ± Karƒ±≈ütƒ±r</span>
        </button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="controls" style="display:none;">
        <div id="message-bubble">Zarƒ± atmak i√ßin tƒ±kla!</div>
        <div id="dice-box">
            <div class="dice-face" id="dice-face"></div>
        </div>
        <div class="dice-label" id="action-label">ZAR AT</div>
    </div>

</div>

<script>
    // --- OYUN SABƒ∞TLERƒ∞ VE AYARLARI ---
    const COLORS = ['#FF5252', '#448AFF', '#69F0AE', '#FFD740', '#E040FB', '#607D8B']; 
    const COLOR_NAMES = {
        '#FF5252': 'KIRMIZI',
        '#448AFF': 'MAVƒ∞',
        '#69F0AE': 'YE≈ûƒ∞L',
        '#FFD740': 'SARI',
        '#E040FB': 'MOR',
        '#607D8B': 'GRƒ∞'
    };

    // DOM Elementleri
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const menuScreen = document.getElementById('menu-screen');
    const roundOverScreen = document.getElementById('round-over-screen');
    const uiLayer = document.getElementById('ui-layer');
    const controls = document.getElementById('controls');
    const extraControls = document.getElementById('extra-controls');
    const msgBubble = document.getElementById('message-bubble');
    const diceBox = document.getElementById('dice-box');
    const diceFace = document.getElementById('dice-face');
    const actionLabel = document.getElementById('action-label');
    const shuffleBtn = document.getElementById('shuffle-btn');
    
    // Skor Elementleri
    const p1Card = document.getElementById('p1-card');
    const p2Card = document.getElementById('p2-card');
    const p1ScoreEl = document.getElementById('p1-score');
    const p2ScoreEl = document.getElementById('p2-score');
    const p1NameEl = document.getElementById('p1-name');
    const p2NameEl = document.getElementById('p2-name');
    const p1WinsEl = document.getElementById('p1-wins');
    const p2WinsEl = document.getElementById('p2-wins');
    
    // Round Over Elemanlarƒ±
    const roundTitle = document.getElementById('round-title');
    const roundWinnerText = document.getElementById('round-winner-text');
    const finalSets1 = document.getElementById('final-sets-1');
    const finalSets2 = document.getElementById('final-sets-2');
    const roundScoreDetail = document.getElementById('round-score-detail');
    const nextRoundBtn = document.getElementById('next-round-btn');
    const mainMenuBtn = document.getElementById('main-menu-btn');

    // Oyun Durumu
    let gameMode = 'pvc'; 
    let pegs = [];
    let currentPlayer = 1; 
    let scores = { 1: 0, 2: 0 };      // Mevcut Tur Skoru (Ta≈ü)
    let matchWins = { 1: 0, 2: 0 };   // Set Skoru
    let targetColor = null;
    let state = 'IDLE'; 
    let aiMemory = {}; 
    let aiDifficulty = 0.85;

    // Canvas Ayarlarƒ±
    let centerX, centerY, boardRadius, pegRadius;

    // --- SINIFLAR ---

    class Peg {
        constructor(index, x, y, color) {
            this.index = index;
            this.x = x;
            this.y = y;
            this.color = color;
            this.isCollected = false;
            this.lift = 0;
            // Animasyon i√ßin ofset deƒüerleri
            this.offsetX = 0;
            this.offsetY = 0;
        }

        draw() {
            if (this.isCollected) return;

            // Animasyonlu pozisyon
            const drawX = this.x + this.offsetX;
            const drawY = this.y - this.lift + this.offsetY;

            // G√∂lge
            if (this.lift < 5) {
                ctx.beginPath();
                ctx.ellipse(drawX + 5, drawY + this.lift + 5, pegRadius, pegRadius * 0.4, 0, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fill();
            }

            // Piyon G√∂vdesi
            ctx.beginPath();
            ctx.arc(drawX, drawY, pegRadius, 0, Math.PI * 2);
            let grad = ctx.createRadialGradient(drawX - pegRadius/3, drawY - pegRadius/3, pegRadius/5, drawX, drawY, pegRadius);
            grad.addColorStop(0, '#f5deb3');
            grad.addColorStop(1, '#d2691e'); 
            ctx.fillStyle = grad;
            ctx.fill();
            ctx.strokeStyle = '#8b4513';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Piyon ƒ∞√ßi
            ctx.beginPath();
            ctx.arc(drawX, drawY, pegRadius * 0.65, 0, Math.PI * 2);
            
            if (this.lift > 0) {
                // Renk
                ctx.fillStyle = this.color;
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.shadowBlur = 5;
            } else {
                // Tepe
                let topGrad = ctx.createRadialGradient(drawX - 5, drawY - 5, 2, drawX, drawY, pegRadius * 0.65);
                topGrad.addColorStop(0, '#fff8dc');
                topGrad.addColorStop(1, '#deb887');
                ctx.fillStyle = topGrad;
            }
            ctx.fill();
            ctx.shadowBlur = 0;

            // Parlaklƒ±k
            ctx.beginPath();
            ctx.arc(drawX - pegRadius*0.3, drawY - pegRadius*0.3, pegRadius * 0.2, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.fill();
        }
    }

    // --- OYUN MANTIƒûI ---

    function resize() {
        const size = Math.min(window.innerWidth, window.innerHeight) * 0.85; 
        canvas.width = size;
        canvas.height = size;
        centerX = canvas.width / 2;
        centerY = canvas.height / 2;
        boardRadius = size / 2 - 10;
        pegRadius = size / 14;

        if (pegs.length > 0) {
            initBoard(); 
        } else {
            drawBoard();
        }
    }

    function initBoard() {
        pegs = [];
        let pool = [];
        COLORS.forEach(c => { for(let i=0; i<4; i++) pool.push(c); });
        
        // Fisher-Yates Karƒ±≈ütƒ±rma
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
        }

        const gridSize = 5;
        const cellSize = (boardRadius * 2) / (gridSize + 1); 
        const startX = centerX - (cellSize * 2);
        const startY = centerY - (cellSize * 2);

        let index = 0;
        for(let r=0; r<gridSize; r++) {
            for(let c=0; c<gridSize; c++) {
                if (r===2 && c===2) continue; 
                if (index < pool.length) {
                    pegs.push(new Peg(
                        index,
                        startX + c * cellSize,
                        startY + r * cellSize,
                        pool[index]
                    ));
                    index++;
                }
            }
        }
        drawBoard();
    }

    function startGame(mode) {
        gameMode = mode;
        matchWins = { 1: 0, 2: 0 }; // Ma√ß skorunu sƒ±fƒ±rla
        
        p1NameEl.innerText = "OYUNCU 1";
        p2NameEl.innerText = gameMode === 'pvc' ? "Bƒ∞LGƒ∞SAYAR" : "OYUNCU 2";

        menuScreen.style.opacity = 0;
        setTimeout(() => menuScreen.style.display = 'none', 500);
        
        startRound();
    }
    
    function startRound() {
        // Tur deƒüi≈ükenlerini sƒ±fƒ±rla
        scores = { 1: 0, 2: 0 };
        currentPlayer = 1;
        state = 'IDLE';
        aiMemory = {};
        targetColor = null;
        
        // UI Hazƒ±rla
        roundOverScreen.style.display = 'none';
        uiLayer.style.display = 'flex';
        controls.style.display = 'flex';
        extraControls.style.display = 'block';
        
        updateScoreUI();
        switchTurnUI();
        resize();
        initBoard(); 
        
        resetDiceVisuals();
        
        showMessage("Yeni Tur! Ba≈ülamak i√ßin Zarƒ± At!");
        enableDice();
    }
    
    function resetDiceVisuals() {
        diceFace.style.backgroundColor = '#ecf0f1';
        diceFace.style.boxShadow = 'inset 0 2px 5px rgba(0,0,0,0.2)';
        diceBox.style.borderColor = '#ecf0f1';
        actionLabel.innerText = "ZAR AT";
        actionLabel.style.color = "white";
    }

    function nextRound() {
        startRound();
    }

    function showMenu() {
        menuScreen.style.display = 'flex';
        setTimeout(() => menuScreen.style.opacity = 1, 10);
        uiLayer.style.display = 'none';
        controls.style.display = 'none';
        extraControls.style.display = 'none';
        roundOverScreen.style.display = 'none';
    }

    // --- OYNANI≈û ---

    function switchTurn() {
        currentPlayer = currentPlayer === 1 ? 2 : 1;
        switchTurnUI();
        targetColor = null;
        
        // Zarƒ± sƒ±fƒ±rla
        resetDiceVisuals();

        if (currentPlayer === 2 && gameMode === 'pvc') {
            state = 'COMPUTER_TURN';
            disableDice();
            shuffleBtn.disabled = true; // Bilgisayar sƒ±rasƒ±nda karƒ±≈ütƒ±rma kapalƒ±
            showMessage("Bilgisayar d√º≈ü√ºn√ºyor...");
            setTimeout(computerPlay, 1200);
        } else {
            state = 'IDLE';
            enableDice();
            shuffleBtn.disabled = false; // Oyuncu sƒ±rasƒ±nda a√ßƒ±k
            showMessage(`Sƒ±ra ${getPlayerName(currentPlayer)}'de. Zarƒ± At!`);
        }
    }
    
    function getPlayerName(id) {
        if(id === 1) return "Oyuncu 1";
        if(gameMode === 'pvc') return "Bilgisayar";
        return "Oyuncu 2";
    }

    function computerPlay() {
        rollDiceLogic(() => {
            showMessage(`Bilgisayar ${COLOR_NAMES[targetColor]} arƒ±yor...`);
            
            setTimeout(() => {
                let targetPeg = null;
                const knownPegIndex = Object.keys(aiMemory).find(idx => 
                    aiMemory[idx] === targetColor && !pegs[idx].isCollected
                );

                if (knownPegIndex && Math.random() < aiDifficulty) {
                    targetPeg = pegs[knownPegIndex];
                } else {
                    const unknownPegs = pegs.filter(p => 
                        !p.isCollected && (!aiMemory[p.index] || aiMemory[p.index] === targetColor)
                    );
                    const candidates = unknownPegs.length > 0 ? unknownPegs : pegs.filter(p => !p.isCollected);
                    targetPeg = candidates[Math.floor(Math.random() * candidates.length)];
                }

                if (targetPeg) revealPeg(targetPeg);
            }, 1000);
        });
    }

    // Karƒ±≈ütƒ±rma ƒ∞≈ülemi
    shuffleBtn.addEventListener('click', shufflePegs);

    function shufflePegs() {
        if (state !== 'IDLE') return;

        playSound('dice'); // Karƒ±≈ütƒ±rma sesi (zar sesiyle aynƒ±)
        
        // 1. Sadece toplanmamƒ±≈ü ta≈ülarƒ± bul
        let activePegs = pegs.filter(p => !p.isCollected);
        let currentColors = activePegs.map(p => p.color);
        
        // 2. Renkleri karƒ±≈ütƒ±r (Fisher-Yates)
        for (let i = currentColors.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [currentColors[i], currentColors[j]] = [currentColors[j], currentColors[i]];
        }
        
        // 3. Renkleri geri ata ve animasyon ba≈ülat
        activePegs.forEach((p, i) => {
            p.color = currentColors[i];
        });

        // 4. Hafƒ±zayƒ± sƒ±fƒ±rla (√á√ºnk√º yerler deƒüi≈üti!)
        aiMemory = {};
        
        showMessage("Ta≈ülar Karƒ±≈ütƒ±rƒ±lƒ±yor...");
        
        // --- Animasyon: Titreme ve Yer Deƒüi≈ütirme Efekti ---
        let frame = 0;
        const totalFrames = 25;
        
        const animInterval = setInterval(() => {
            frame++;
            activePegs.forEach(p => {
                // Rastgele bir y√∂ne savrul
                p.offsetX = (Math.random() - 0.5) * 20; 
                p.offsetY = (Math.random() - 0.5) * 20;
                p.lift = 8; // Hafif√ße havalan
            });
            drawBoard();

            if (frame >= totalFrames) {
                clearInterval(animInterval);
                // Sƒ±fƒ±rla ve yerine oturt
                activePegs.forEach(p => {
                    p.offsetX = 0;
                    p.offsetY = 0;
                    p.lift = 0;
                });
                drawBoard();
                showMessage("Ta≈ülar Karƒ±≈ütƒ±rƒ±ldƒ±! Hafƒ±zalar Silindi.");
            }
        }, 30);
    }

    // Zar ƒ∞≈ülevleri
    diceBox.addEventListener('click', () => {
        if (state !== 'IDLE') return;
        
        state = 'ROLLING';
        disableDice();
        shuffleBtn.disabled = true; // Zar atƒ±lƒ±nca karƒ±≈ütƒ±rma kapanƒ±r
        rollDiceLogic(() => {
            state = 'PICKING';
            showMessage(`${COLOR_NAMES[targetColor]} rengi bul!`);
        });
    });

    function rollDiceLogic(callback) {
        playSound('dice');
        let rolls = 0;
        const maxRolls = 12;
        const interval = setInterval(() => {
            rolls++;
            const randColor = COLORS[Math.floor(Math.random() * COLORS.length)];
            diceFace.style.backgroundColor = randColor;
            diceFace.style.boxShadow = `0 0 15px ${randColor}`;
            actionLabel.style.color = randColor;
            diceBox.style.borderColor = randColor;
            
            diceBox.style.transform = `rotate(${Math.random() * 20 - 10}deg) scale(0.95)`;

            if (rolls > maxRolls) {
                clearInterval(interval);
                diceBox.style.transform = 'none';
                
                const availableColors = [...new Set(pegs.filter(p => !p.isCollected).map(p => p.color))];
                if (availableColors.length === 0) {
                    checkRoundEnd(true); // Forced end
                    return;
                }
                
                targetColor = availableColors[Math.floor(Math.random() * availableColors.length)];
                
                // Final rengi ve etiketi set et
                const colorName = COLOR_NAMES[targetColor];
                diceFace.style.backgroundColor = targetColor;
                diceFace.style.boxShadow = `0 0 20px ${targetColor}, inset 0 0 10px rgba(0,0,0,0.2)`;
                
                diceBox.style.borderColor = targetColor;
                actionLabel.innerText = colorName;
                actionLabel.style.color = targetColor;
                
                if (callback) callback();
            }
        }, 80);
    }

    // Ta≈ü Se√ßimi
    canvas.addEventListener('click', (e) => {
        if (state !== 'PICKING') return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        for (let peg of pegs) {
            if (!peg.isCollected) {
                const dist = Math.sqrt((x - peg.x) ** 2 + (y - peg.y) ** 2);
                if (dist < pegRadius * 1.5) { 
                    revealPeg(peg);
                    break;
                }
            }
        }
    });

    function revealPeg(peg) {
        state = 'ANIMATING';
        aiMemory[peg.index] = peg.color;

        let lift = 0;
        const upInterval = setInterval(() => {
            lift += 2;
            peg.lift = lift;
            drawBoard();

            if (lift >= 20) {
                clearInterval(upInterval);
                setTimeout(() => checkMatch(peg), 600);
            }
        }, 16);
    }

    function checkMatch(peg) {
        if (peg.color === targetColor) {
            playSound('success');
            showMessage("DOƒûRU RENK! +1 Puan");
            
            peg.isCollected = true;
            peg.lift = 0;
            scores[currentPlayer]++;
            updateScoreUI();
            drawBoard();

            // Tur biti≈ü kontrol√º: 15'e ula≈üan var mƒ±?
            if (scores[currentPlayer] >= 15) {
                handleRoundWin(currentPlayer, "15 Ta≈üa Ula≈ütƒ±!");
            }
            // Veya t√ºm ta≈ülar bitti mi? (24 ta≈ü)
            else if (scores[1] + scores[2] === 24) {
                checkRoundEnd(false);
            } 
            else {
                // Devam et (Doƒüru bilen tekrar oynar)
                state = 'IDLE';
                // Hedef renk null, zarƒ± resetle
                targetColor = null;
                resetDiceVisuals();

                if (gameMode === 'pvc' && currentPlayer === 2) {
                    setTimeout(() => {
                        showMessage("Bilgisayar tekrar oynuyor...");
                        computerPlay();
                    }, 1000);
                } else {
                    enableDice();
                    shuffleBtn.disabled = false;
                    showMessage("Tekrar at!");
                }
            }

        } else {
            playSound('fail');
            showMessage("YANLI≈û! Sƒ±ra Ge√ßiyor.");
            
            let lift = 20;
            const downInterval = setInterval(() => {
                lift -= 2;
                peg.lift = lift;
                drawBoard();

                if (lift <= 0) {
                    clearInterval(downInterval);
                    switchTurn();
                }
            }, 16);
        }
    }

    function checkRoundEnd(forced) {
        if (scores[1] > scores[2]) handleRoundWin(1, "Tur Skoru √úst√ºnl√ºƒü√º");
        else if (scores[2] > scores[1]) handleRoundWin(2, "Tur Skoru √úst√ºnl√ºƒü√º");
        else handleRoundWin(0, "Beraberlik"); // Beraberlik durumunda set verilmez
    }

    function handleRoundWin(winnerId, reason) {
        let title = "TUR Bƒ∞TTƒ∞";
        let winnerText = "Berabere!";
        
        if (winnerId !== 0) {
            matchWins[winnerId]++;
            winnerText = `${getPlayerName(winnerId)} Kazandƒ±! (${reason})`;
            playSound('win');
        } else {
            winnerText = "Tur Berabere! Set Puanƒ± Yok.";
        }
        
        updateScoreUI(); // Set yƒ±ldƒ±zlarƒ±nƒ± g√ºncelle

        // Ma√ß Bitti mi? (3 olan kazanƒ±r)
        if (matchWins[winnerId] >= 3) {
             title = "üèÜ MA√áIN GALƒ∞Bƒ∞ üèÜ";
             winnerText = getPlayerName(winnerId).toUpperCase() + " ≈ûAMPƒ∞YON!";
             nextRoundBtn.style.display = 'none'; // Sadece ana men√º butonu kalsƒ±n
             playSound('win'); // Uzun zafer m√ºziƒüi √ßalƒ±nabilir
        } else {
             nextRoundBtn.style.display = 'inline-block';
             nextRoundBtn.innerText = "Sƒ±radaki Tur (" + (matchWins[1]+matchWins[2]+1) + ". Tur)";
        }

        // Modal G√∂ster
        roundTitle.innerText = title;
        roundWinnerText.innerText = winnerText;
        finalSets1.innerText = matchWins[1];
        finalSets2.innerText = matchWins[2];
        roundScoreDetail.innerText = `Ta≈ülar: ${scores[1]} - ${scores[2]}`;
        
        roundOverScreen.style.display = 'flex';
        extraControls.style.display = 'none'; // Round over ekranƒ±nda gizle
    }

    // --- YARDIMCI FONKSƒ∞YONLAR ---

    function drawBoard() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.save();
        ctx.beginPath();
        ctx.arc(centerX, centerY, boardRadius, 0, Math.PI * 2);
        let boardGrad = ctx.createRadialGradient(centerX, centerY, boardRadius * 0.2, centerX, centerY, boardRadius);
        boardGrad.addColorStop(0, '#deb887');
        boardGrad.addColorStop(1, '#cd853f'); 
        ctx.fillStyle = boardGrad;
        ctx.fill();
        ctx.lineWidth = 8;
        ctx.strokeStyle = '#8b4513';
        ctx.stroke();
        ctx.restore();

        pegs.forEach(p => {
            if (p.isCollected) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, pegRadius * 0.4, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.stroke();
            }
        });

        pegs.forEach(p => p.draw());
    }

    function updateScoreUI() {
        p1ScoreEl.innerText = scores[1];
        p2ScoreEl.innerText = scores[2];
        
        // Yƒ±ldƒ±zlarƒ± g√ºncelle
        updateStars(p1WinsEl, matchWins[1]);
        updateStars(p2WinsEl, matchWins[2]);
    }
    
    function updateStars(container, count) {
        const stars = container.children;
        for(let i=0; i<3; i++) {
            if(i < count) stars[i].classList.add('filled');
            else stars[i].classList.remove('filled');
        }
    }

    function switchTurnUI() {
        if (currentPlayer === 1) {
            p1Card.classList.add('active');
            p2Card.classList.remove('active');
        } else {
            p1Card.classList.remove('active');
            p2Card.classList.add('active');
        }
    }

    function showMessage(text) {
        msgBubble.innerText = text;
        msgBubble.classList.add('visible');
    }

    function enableDice() {
        diceBox.classList.remove('disabled');
        // Etiket zarƒ± attƒ±ktan sonra deƒüi≈üeceƒüi i√ßin burada resetlemiyoruz, 
        // ancak yeni tur ba≈ülangƒ±cƒ±nda resetliyoruz.
        diceBox.style.opacity = 1;
    }

    function disableDice() {
        diceBox.classList.add('disabled');
        // actionLabel.style.opacity = 0.5; // Artƒ±k renkli olduƒüu i√ßin opaklƒ±k deƒüi≈ütirmeyelim
    }

    // Ses Efektleri
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'dice') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start();
            osc.stop(now + 0.1);
        }
        else if (type === 'success') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start();
            osc.stop(now + 0.3);
        }
        else if (type === 'fail') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(150, now + 0.3);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start();
            osc.stop(now + 0.3);
        }
        else if (type === 'win') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.setValueAtTime(500, now + 0.2);
            osc.frequency.setValueAtTime(600, now + 0.4);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 1.0);
            osc.start();
            osc.stop(now + 1.0);
        }
    }

    window.addEventListener('resize', resize);
    window.onload = () => {
        resize();
        initBoard(); 
    };

</script>

</body>
</html>


